<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Architecture â€” Everything App Docs</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
<div class="docs-layout">
  <nav class="sidebar">
    <a href="index.html" class="sidebar-brand">ğŸ“± Everything App</a>
    <div class="sidebar-section">
      <div class="sidebar-section-title">Getting Started</div>
      <a href="getting-started.html" class="sidebar-link">Installation &amp; Setup</a>
    </div>
    <div class="sidebar-section">
      <div class="sidebar-section-title">Architecture</div>
      <a href="architecture.html" class="sidebar-link active">Overview</a>
      <a href="architecture.html#layers" class="sidebar-link">Layer Responsibilities</a>
      <a href="architecture.html#data-flow" class="sidebar-link">Data Flow</a>
    </div>
    <div class="sidebar-section">
      <div class="sidebar-section-title">API Reference</div>
      <a href="api-models.html" class="sidebar-link">Models</a>
      <a href="api-services.html" class="sidebar-link">Services</a>
      <a href="api-state.html" class="sidebar-link">State Management</a>
      <a href="api-data.html" class="sidebar-link">Data Layer</a>
    </div>
    <div class="sidebar-section">
      <div class="sidebar-section-title">Guides</div>
      <a href="security.html" class="sidebar-link">Security</a>
      <a href="testing.html" class="sidebar-link">Testing</a>
      <a href="contributing.html" class="sidebar-link">Contributing</a>
    </div>
  </nav>
  <main class="content">
    <div class="breadcrumb"><a href="index.html">Docs</a> <span>/</span> Architecture</div>
    <h1>Architecture</h1>
    <p class="subtitle">Clean, layered Flutter architecture with clear separation of concerns.</p>

    <h2 id="overview">Overview</h2>
    <p>The Everything App follows a <strong>layered architecture</strong> pattern that separates the codebase into distinct responsibilities. Each layer depends only on the layer below it, preventing circular dependencies and making the code testable in isolation.</p>

    <div class="arch-diagram">
      <pre>
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Views Layer                        â”‚
â”‚  HomeScreen Â· LoginScreen Â· StatsScreen Â· Widgets     â”‚
â”‚  (StatelessWidget / StatefulWidget â€” UI only)         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                   State Layer                         â”‚
â”‚    EventProvider (ChangeNotifier) â€” primary state      â”‚
â”‚    EventBloc (Cubit) â€” alternative BLoC pattern        â”‚
â”‚    UserProvider (ChangeNotifier) â€” user session         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                  Services Layer                        â”‚
â”‚  EventService â€” coordinates persistence + state        â”‚
â”‚  AuthService â€” Firebase Auth wrapper                   â”‚
â”‚  GraphService â€” Microsoft Graph API client             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                   Data Layer                           â”‚
â”‚  LocalStorage â€” SQLite singleton (sqflite)             â”‚
â”‚  EventRepository Â· UserRepository â€” CRUD operations    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                  Models Layer                          â”‚
â”‚  EventModel Â· EventTag Â· RecurrenceRule Â· UserModel    â”‚
â”‚  (Immutable, with copyWith, fromJson/toJson)           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      </pre>
    </div>

    <h2 id="layers">Layer Responsibilities</h2>

    <h3>Models</h3>
    <p>Pure Dart classes with no Flutter dependencies. All models are designed to be:</p>
    <ul>
      <li><strong>Immutable</strong> â€” fields are <code>final</code>, mutations use <code>copyWith()</code></li>
      <li><strong>Serializable</strong> â€” <code>fromJson()</code> / <code>toJson()</code> for SQLite and API</li>
      <li><strong>Value-equatable</strong> â€” overridden <code>==</code> and <code>hashCode</code></li>
    </ul>

    <div class="card-grid">
      <div class="card">
        <h4>ğŸ“‹ EventModel</h4>
        <p>Core event with id, title, description, date, priority, tags, and recurrence. Generates recurring occurrences via <code>generateOccurrences()</code>.</p>
      </div>
      <div class="card">
        <h4>ğŸ·ï¸ EventTag</h4>
        <p>Color-coded categorization with 8 preset colors and common tag presets (Work, Personal, Meeting, etc.).</p>
      </div>
      <div class="card">
        <h4>ğŸ”„ RecurrenceRule</h4>
        <p>Daily/weekly/monthly/yearly recurrence with configurable intervals and optional end dates. Handles month-length clamping (Jan 31 + 1 month = Feb 28).</p>
      </div>
      <div class="card">
        <h4>ğŸ‘¤ UserModel</h4>
        <p>User identity with id, name, and email. Persisted to local storage for session restoration.</p>
      </div>
    </div>

    <h3>Data Layer</h3>
    <p>The data layer handles all persistence through two components:</p>
    <ul>
      <li><strong>LocalStorage</strong> â€” Singleton SQLite manager with versioned schema migrations (v1â†’v4). All queries use parameterized bindings to prevent SQL injection.</li>
      <li><strong>Repositories</strong> â€” Thin wrappers around LocalStorage that provide domain-specific CRUD operations (<code>EventRepository</code>, <code>UserRepository</code>).</li>
    </ul>

    <div class="callout callout-info">
      <strong>Schema Versions</strong>
      v1: Basic users + events tables. v2: Added description + priority. v3: Added tags (JSON). v4: Added recurrence (JSON). Each migration is applied incrementally via <code>onUpgrade</code>.
    </div>

    <h3>Services Layer</h3>
    <p>Services coordinate between the data layer and state layer:</p>
    <ul>
      <li><strong>EventService</strong> â€” The single point of coordination for all event mutations. Updates in-memory state first (for responsiveness), then persists to disk asynchronously. Persistence errors are logged but don't crash the UI.</li>
      <li><strong>AuthService</strong> â€” Wraps Firebase Auth with typed <code>AuthException</code> errors. Maps Firebase error codes to human-readable identifiers.</li>
      <li><strong>GraphService</strong> â€” Microsoft Graph API client with paginated event fetching. Includes SSRF protection â€” pagination links are validated against trusted hosts.</li>
    </ul>

    <h3>State Layer</h3>
    <p>Two state management approaches coexist:</p>
    <table>
      <tr><th>Pattern</th><th>Implementation</th><th>Use Case</th></tr>
      <tr><td>Provider</td><td><code>EventProvider</code>, <code>UserProvider</code></td><td>Primary UI state â€” O(1) indexed lookups, unmodifiable list exposure</td></tr>
      <tr><td>BLoC</td><td><code>EventBloc</code> (Cubit)</td><td>Alternative pattern â€” state machine with <code>EventInitial</code>, <code>EventLoaded</code>, <code>EventError</code> states</td></tr>
    </table>

    <h3>Views Layer</h3>
    <p>Flutter widgets that consume state and render UI. No business logic lives here â€” widgets delegate all mutations to services/providers.</p>

    <h2 id="data-flow">Data Flow</h2>

    <h3>Authentication Flow</h3>
    <div class="arch-diagram">
      <pre>
App Start â†’ Firebase.initializeApp()
         â†’ AuthGate (StreamBuilder on authStateChanges)
            â”œâ”€ User exists â†’ restore UserProvider â†’ HomeScreen
            â””â”€ No user â†’ LoginScreen
                          â†’ AuthService.loginWithEmail()
                          â†’ Firebase Auth
                          â†’ UserProvider.setUser() + UserRepository.saveUser()
                          â†’ Navigate to HomeScreen
      </pre>
    </div>

    <h3>Event CRUD Flow</h3>
    <div class="arch-diagram">
      <pre>
UI Action (e.g., "Add Event")
  â†’ EventService.addEvent(event)
    â†’ EventProvider.addEvent()     â† in-memory (instant UI update)
    â†’ EventRepository.saveEvent()  â† async persistence (fire-and-forget)
  â†’ UI rebuilds via ChangeNotifier
      </pre>
    </div>

    <h3>Microsoft Graph Sync Flow</h3>
    <div class="arch-diagram">
      <pre>
User triggers sync
  â†’ GraphService.fetchCalendarEvents(accessToken)
    â†’ GET /me/events?$top=50
    â†’ Follow @odata.nextLink (validated against trustedApiHosts)
    â†’ Collect all pages (max 50 pages safety limit)
  â†’ Map to EventModel list
  â†’ EventService.setEvents() / merge
      </pre>
    </div>

    <h2 id="key-patterns">Key Design Patterns</h2>

    <div class="card-grid">
      <div class="card">
        <h4>ğŸ­ Singleton Database</h4>
        <p><code>LocalStorage._db</code> ensures only one database connection exists. Lazy-initialized on first access.</p>
      </div>
      <div class="card">
        <h4>ğŸ“‡ O(1) Index Map</h4>
        <p><code>EventProvider._idIndex</code> maps event IDs to list indices, enabling constant-time lookups, updates, and deletions.</p>
      </div>
      <div class="card">
        <h4>ğŸ”¥ Fire-and-Forget Persistence</h4>
        <p>EventService updates in-memory state first for instant UI response, then persists asynchronously. Disk errors are logged, not surfaced.</p>
      </div>
      <div class="card">
        <h4>ğŸ›¡ï¸ Typed Exceptions</h4>
        <p><code>AuthException</code>, <code>HttpException</code>, <code>HttpSecurityException</code>, <code>GraphServiceException</code> â€” each error type carries structured context for proper handling.</p>
      </div>
    </div>

    <div class="docs-footer">
      <p>ğŸ“± Everything App Documentation Â· <a href="https://github.com/sauravbhattacharya001/everything">GitHub</a></p>
    </div>
  </main>
</div>
</body>
</html>
